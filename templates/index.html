<!DOCTYPE html>
<html lang="en" id="html" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>DeepSeek</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .dark .prose { color: #e5e7eb; }
    .dark .prose strong { color: #e5e7eb; }
    .dark .prose code { color: #facc15; }
    .dark .prose a { color: #93c5fd; }
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background-color: rgba(120, 120, 120, 0.4);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box;
    }
    ::-webkit-scrollbar-thumb:hover {
      background-color: rgba(120, 120, 120, 0.6);
    }
  </style>
</head>
<body class="flex flex-col h-screen w-screen bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100">

  <!-- Header -->
  <header class="absolute top-4 left-4 flex items-center px-4 py-2 bg-gray-200 dark:bg-gray-800 text-gray-900 dark:text-white shadow-md z-50 rounded-xl">
    <div class="relative" id="modelDropdownWrapper">
      <button id="modelDropdownButton"
              class="flex items-center text-xl font-semibold px-3 py-1 border border-transparent bg-transparent text-gray-900 dark:text-white focus:outline-none cursor-pointer">
        <span id="selectedModel">Loading...</span>
        <svg id="dropdownIcon" class="ml-2 w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" stroke-width="2"
             viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>
      <div id="modelDropdownMenu"
           class="hidden absolute left-0 mt-2 w-full z-10 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg max-h-60 overflow-auto">
        <!-- Items inserted here -->
      </div>
    </div>
    <input type="hidden" id="modelInput" name="model" />
    <button id="toggleDark"
            class="ml-4 text-xl text-yellow-500 dark:text-yellow-300 bg-transparent hover:text-yellow-400 transition">
      🌙
    </button>
  </header>

  <!-- Chat Area -->
  <main class="flex-grow overflow-hidden flex flex-col items-center pt-20 bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="w-full max-w-3xl flex flex-col px-6 py-6 overflow-y-auto h-full scrollbar-thin scrollbar-thumb-gray-400/40 scrollbar-thumb-rounded-md pb-6" id="conversationHistory"></div>
  </main>

  <!-- Input Area -->
  <form id="queryForm" class="bg-gray-200 dark:bg-gray-800 w-full flex justify-center p-4 shadow-inner">
    <div class="relative w-full max-w-3xl">
      <textarea id="inputText" name="query" rows="3" placeholder="Send a message..." required
                class="w-full border border-gray-400 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-lg pr-14 p-4 resize-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>

      <!-- Submit Button -->
      <button type="submit" id="submitBtn"
              class="absolute bottom-3 right-3 w-10 h-10 flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow transition disabled:opacity-50">
        ➔
      </button>

      <!-- Spinner -->
      <div id="loading"
           class="hidden absolute bottom-3 left-3 text-base text-gray-500 dark:text-gray-300 pointer-events-none">
        <span class="animate-spin inline-block w-5 h-5 border-2 border-current border-t-transparent rounded-full"></span>
        Thinking...
      </div>
    </div>
  </form>

  <script>
    const html = document.getElementById('html');
    const toggleBtn = document.getElementById('toggleDark');
    const modelMenu = document.getElementById('modelDropdownMenu');
    const modelButton = document.getElementById('modelDropdownButton');
    const modelInput = document.getElementById('modelInput');
    const selectedModelSpan = document.getElementById('selectedModel');
    const dropdownIcon = document.getElementById('dropdownIcon');
    const historyDiv = document.getElementById('conversationHistory');
    const inputText = document.getElementById('inputText');
    const loading = document.getElementById('loading');
    const submitBtn = document.getElementById('submitBtn');

    function updateDarkModeIcon() {
      toggleBtn.textContent = html.classList.contains('dark') ? '🌙' : '☀️';
    }

    toggleBtn.addEventListener('click', () => {
      html.classList.toggle('dark');
      updateDarkModeIcon();
    });

    function toggleDropdown(forceClose = false) {
      const open = !forceClose && modelMenu.classList.contains('hidden');
      modelMenu.classList.toggle('hidden', !open);
      dropdownIcon.classList.toggle('rotate-180', open);
    }

    document.addEventListener('click', (e) => {
      if (!document.getElementById('modelDropdownWrapper').contains(e.target)) {
        toggleDropdown(true);
      }
    });

    function selectModel(model) {
      selectedModelSpan.textContent = model;
      modelInput.value = model;
      toggleDropdown(true);
      document.title = `DeepSeek - ${model}`;
    }

    function loadModels() {
      fetch('/get-models')
        .then(res => res.json())
        .then(data => {
          modelMenu.innerHTML = '';
          data.models.forEach((model, i) => {
            const item = document.createElement('div');
            item.className = "px-4 py-2 text-sm cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-900 dark:text-gray-100";
            item.textContent = model;
            item.addEventListener('click', () => selectModel(model));
            modelMenu.appendChild(item);
            if (i === 0) selectModel(model);
          });
        });
    }

    modelButton.addEventListener('click', () => toggleDropdown());

    document.addEventListener('DOMContentLoaded', () => {
      loadModels();
      updateDarkModeIcon();
      inputText.focus();
    });

    inputText.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('queryForm').requestSubmit();
      }
    });

    document.getElementById('queryForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const query = inputText.value.trim();
      if (!query) return;

      const formData = new FormData(e.target);
      formData.append('model', modelInput.value);

      loading.classList.remove('hidden');
      submitBtn.disabled = true;

      const userMsg = document.createElement('div');
      userMsg.className = "mb-4 self-start bg-gray-300 dark:bg-gray-800 p-3 rounded-md";
      userMsg.innerHTML = `<strong class="block text-indigo-600 dark:text-indigo-400 mb-1">You:</strong><p>${query}</p>`;
      historyDiv.appendChild(userMsg);

      const res = await fetch('/query-ai', { method: 'POST', body: formData });
      const data = await res.json();
      const cleanResponse = data.response.replace(/<think>/gi, '').replace(/<\/think>/gi, '');

      const aiMsg = document.createElement('div');
      aiMsg.className = "mb-4 self-start bg-gray-200 dark:bg-gray-700 p-3 rounded-md prose prose-sm dark:prose-invert max-w-none";
      aiMsg.innerHTML = `<strong class="block text-green-600 dark:text-green-400 mb-1">AI:</strong>${marked.parse(cleanResponse)}`;
      historyDiv.appendChild(aiMsg);

      loading.classList.add('hidden');
      submitBtn.disabled = false;
      inputText.value = ''; inputText.blur(); inputText.focus();
      inputText.focus();
      historyDiv.scrollTop = historyDiv.scrollHeight;
    });
  </script>
</body>
</html>
