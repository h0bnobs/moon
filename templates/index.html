<!DOCTYPE html>
<html lang="en" id="html" class="dark">
<head>
  <meta charset="UTF-8" />
  <title>DeepSeek</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    .dark .prose { color: #e5e7eb; }
    .dark .prose strong { color: #e5e7eb; }
    .dark .prose code { color: #facc15; }
    .dark .prose a { color: #93c5fd; }
  </style>
</head>
<body class="flex flex-col h-screen w-screen bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100">

  <!-- Header -->
  <header class="flex justify-center items-center px-6 py-4 bg-gray-200 dark:bg-gray-800 text-gray-900 dark:text-white shadow-md relative">
    <select id="modelDropdown"
            class="appearance-none bg-transparent text-xl font-semibold text-gray-900 dark:text-white border border-gray-400 dark:border-gray-600 rounded-md px-4 py-1 focus:outline-none focus:ring focus:border-indigo-500">
    </select>
    <button id="toggleDark"
            class="absolute right-6 top-4 text-xl text-yellow-500 dark:text-yellow-300 bg-transparent hover:text-yellow-400 transition">
      ðŸŒ™
    </button>
  </header>

  <!-- Chat Area -->
  <main class="flex-grow overflow-hidden flex flex-col items-center bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <div class="w-full max-w-3xl flex flex-col px-4 py-6 overflow-y-auto h-full"
         id="conversationHistory">
      <!-- Messages will appear here -->
    </div>
  </main>

  <!-- Input Area -->
  <form id="queryForm" class="bg-gray-200 dark:bg-gray-800 w-full flex justify-center p-4 shadow-inner">
    <div class="relative w-full max-w-3xl">
      <textarea id="inputText" name="query" rows="3" placeholder="Send a message..." required
                class="w-full border border-gray-400 dark:border-gray-600 bg-white dark:bg-gray-900 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 rounded-lg pr-14 p-4 resize-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>

      <!-- Submit Button (Circle) -->
      <button type="submit"
              id="submitBtn"
              class="absolute bottom-3 right-3 w-10 h-10 flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow transition disabled:opacity-50">
        âž¤
      </button>

      <!-- Spinner -->
      <div id="loading" class="hidden mt-2 text-center text-sm text-gray-500 dark:text-gray-300">
        <span class="animate-spin inline-block w-5 h-5 border-2 border-current border-t-transparent rounded-full"></span>
        Thinking...
      </div>
    </div>
  </form>

  <script>
    const html = document.getElementById('html');
    const toggleBtn = document.getElementById('toggleDark');
    const dropdown = document.getElementById('modelDropdown');
    const historyDiv = document.getElementById('conversationHistory');
    const inputText = document.getElementById('inputText');
    const loading = document.getElementById('loading');
    const submitBtn = document.getElementById('submitBtn');

    function updateDarkModeIcon() {
      toggleBtn.textContent = html.classList.contains('dark') ? 'ðŸŒ™' : 'ðŸŒž';
    }

    toggleBtn.addEventListener('click', () => {
      html.classList.toggle('dark');
      updateDarkModeIcon();
    });

    document.addEventListener('DOMContentLoaded', () => {
      fetch('/get-models')
        .then(res => res.json())
        .then(data => {
          data.models.forEach((model, i) => {
            const opt = document.createElement('option');
            opt.value = model;
            opt.textContent = model;
            dropdown.appendChild(opt);
            if (i === 0) document.title = `DeepSeek - ${model}`;
          });

          dropdown.addEventListener('change', () => {
            document.title = `DeepSeek - ${dropdown.value}`;
          });
        });

      updateDarkModeIcon();
      inputText.focus();
    });

    document.getElementById('queryForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const query = inputText.value.trim();
      if (!query) return;

      const formData = new FormData(e.target);
      formData.append('model', dropdown.value); // âœ… Manually include model

      loading.classList.remove('hidden');
      submitBtn.disabled = true;

      // Add user message
      const userMsg = document.createElement('div');
      userMsg.className = "mb-4 self-start bg-gray-300 dark:bg-gray-800 p-3 rounded-md";
      userMsg.innerHTML = `<strong class="block text-indigo-600 dark:text-indigo-400 mb-1">You:</strong><p>${query}</p>`;
      historyDiv.appendChild(userMsg);

      const res = await fetch('/query-ai', { method: 'POST', body: formData });
      const data = await res.json();
      const cleanResponse = data.response.replace(/<think>/gi, '').replace(/<\/think>/gi, '');

      const aiMsg = document.createElement('div');
      aiMsg.className = "mb-4 self-start bg-gray-200 dark:bg-gray-700 p-3 rounded-md prose prose-sm dark:prose-invert max-w-none";
      aiMsg.innerHTML = `<strong class="block text-green-600 dark:text-green-400 mb-1">AI:</strong>${marked.parse(cleanResponse)}`;
      historyDiv.appendChild(aiMsg);

      loading.classList.add('hidden');
      submitBtn.disabled = false;
      inputText.value = '';
      inputText.focus();
      historyDiv.scrollTop = historyDiv.scrollHeight;
    });
  </script>
</body>
</html>
